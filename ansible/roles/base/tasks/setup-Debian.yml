---
- name: Install base packages
  become: true
  apt:
    state: present
    name: "{{ base_packages }}"
    update_cache: yes
  tags: [install]

# Auditd is spamming the logs when the workers are busy.
# Disable for now
- name: Disable auditd
  become: true
  ansible.builtin.systemd:
    name: auditd
    state: stopped
    enabled: no
    masked: yes

# When atopacct is running, it holds semaphore that prevent atop from working
# Further troubleshooting would need to be done, but atop can do just fine on its own.
# Note that even stopping `atopacct` leaves semaphores... either reboot or clean them
# manually.
# Possibly related: https://lkml.org/lkml/2016/12/19/182
- name: Disable atopacct
  become: true
  ansible.builtin.service:
    name: atopacct
    state: stopped
    enabled: false

- name: Setup atop
  become: true
  ansible.builtin.copy:
    dest: "/etc/default/atop"
    content: |
      # This file is generated by Ansible, do not modify
      LOGOPTS="-R"
      LOGINTERVAL={{ atop_interval }}
      LOGGENERATIONS=28
      LOGPATH=/var/log/atop
    mode: 0644
    owner: root
    group: root
  register: atop_conf


- name: Start and Enable atop
  become: yes
  ansible.builtin.service:
    name: atop
    state: started
    enabled: yes

- name: restart atop
  become: yes
  service:
    name: atop
    state: restarted
  when: atop_conf.changed
