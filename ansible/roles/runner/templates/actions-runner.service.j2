[Unit]
Description=Self-Hosted IBM Z Github Actions Runner %i ({{ item.name }})
Wants=qemu-user-static.service
After=qemu-user-static.service
StartLimitIntervalSec=0

[Service]
Type=simple
Restart=always
ExecStart=/usr/bin/docker run \
              --device=/dev/kvm \
              --env-file={{ runner_base_dir }}/actions-runner-{{ item.normalized }}-worker-%i \
              --init \
              --interactive \
              --name=actions-runner-{{ item.normalized }}-worker-%i \
              --rm \
              --health-cmd='(ss -ntp -H dport = :443 | grep -q ESTAB) || exit 1' \
              --health-start-period=60s --health-interval=30s --health-timeout=5s --health-retries=3 \
              --volume=actions-runner-{{ item.normalized }}-worker-%i:/home/actions-runner \
              iiilinuxibmcom/actions-runner-{{ item.normalized }}
ExecStop=/bin/sh -c "docker exec actions-runner-{{ item.normalized }}-worker-%i kill -INT -- -1"
ExecStop=/bin/sh -c "docker wait actions-runner-{{ item.normalized }}-worker-%i"
ExecStop=/bin/sh -c "docker rm actions-runner-{{ item.normalized }}-worker-%i"

[Install]
WantedBy=multi-user.target
